---
name: _test
description: Test trigger workflow

on:
  workflow_call:
    inputs:
      build_matrix:
        required: true
        type: string
        description: Build matrix for the test job
      
      # === Optional knobs for lava-test-plans ===
      distro_name:
        description: Default distro for lava-test-plans if not provided in matrix
        required: false
        type: string
        default: qcom-distro
      kernel:
        description: Extra path suffix for kernel (e.g., -6.18). Default empty.
        required: false
        type: string
        default: ""
      testplan:
        description: Test plan name to use in job generation (lava-test-plans)
        required: false
        type: string
        default: pre-merge
      prefix:
        description: Prefix for the compressed artifact with generated jobs
        required: false
        type: string
        default: testjobs
      
      # === LAVA server configuration ===
      lava_url:
        description: LAVA server URL
        required: false
        type: string
        default: lava.infra.foundries.io
      wait_for_job:
        description: Wait for LAVA job to complete
        required: false
        type: boolean
        default: true
      fail_on_test_failure:
        description: Fail workflow if LAVA test fails
        required: false
        type: boolean
        default: false

jobs:
 submit_lava:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        build_matrix: ${{ fromJson(inputs.build_matrix) }}
    
    steps:
      - name: Sync Codebase
        id: sync
        uses: Audioreach/meta-audioreach/.github/actions/sync@master
        with:
          event_name: ${{ github.event_name }}
          pr_ref:  ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.ref || '' }}
          pr_repo: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name || '' }}
          base_ref: ${{ github.ref_name }}

      - name: Process URLs
        id: process_urls
        uses: Audioreach/meta-audioreach/.github/actions/process_urls@master
        env:
          MACHINE: ${{ matrix.build_matrix.machine_name }}
          ARTIFACT_KEY: ${{ matrix.build_matrix.kas_file }}

      - name: Print trigger info
        id: print_trigger
        run: |
          echo "Triggered by ${{ github.event_name }}"
          echo "Build URL: ${{ steps.process_urls.outputs.flat_build_url }}"
          echo "Build file name: ${{ steps.process_urls.outputs.filename }}"
          echo "Image: ${{ matrix.build_matrix.image_name }}"
          echo "Machine: ${{ matrix.build_matrix.machine_name }}"
          KAS_FILE="${{ matrix.build_matrix.kas_file }}"
          KAS_FILE="${KAS_FILE##*/}"
          IMAGE_NAME="${KAS_FILE%.*}"
          echo "image_name=$IMAGE_NAME" >> "$GITHUB_OUTPUT" 
      
      - name: Submit LAVA test job
        id: lava_submit
        uses: Audioreach/meta-audioreach/.github/actions/lava-test-plans@master
        with:
          image_name: ${{ steps.print_trigger.outputs.image_name}}
          machine_name: ${{ matrix.build_matrix.machine_name }}
          build_url: ${{ steps.process_urls.outputs.flat_build_url }}
          distro_name: ${{ inputs.distro_name }}
          kernel: ${{ inputs.kernel }}
          testplan: ${{ inputs.testplan }}
          prefix: ${{ inputs.prefix }}
          lava_token: ${{ secrets.LAVATOKEN }}
          lava_url: ${{ inputs.lava_url }}
          wait_for_job: ${{ inputs.wait_for_job }}
          fail_action_on_failure: ${{ inputs.fail_on_test_failure }}
          run_id: ${{ github.run_id }}
          run_attempt: ${{ github.run_attempt }}
  
 publish-test-summary:
    name: "Publish Tests Summary"
    needs: [submit_lava]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write
    outputs:
      summary_id: ${{ steps.generate-summary.outputs.artifact_id }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Summary
        id: generate-summary
        uses: Audioreach/meta-audioreach/.github/actions/test-job-summary@master
        with:
          build_id: ${{ github.run_id }}
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          summary_file_name: test_job_summary
      
      # Download ALL matching summary artifacts from parallel jobs and put into one folder.
      - name: Download Summaries
        uses: actions/download-artifact@v6
        with:
          pattern: test_job_summary*          # match all parallel summaries
          merge-multiple: true                # place all matched artifact contents into a single folder
          path: summaries

      - name: Publish Test Job Details
        run: |
          shopt -s nullglob
          files=(summaries/test_job_summary*)
          if [ ${#files[@]} -eq 0 ]; then
            echo ":warning: No test job summaries were found to publish." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "## LAVA Test Job Summaries" >> "$GITHUB_STEP_SUMMARY"
          for f in "${files[@]}"; do
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### $(basename "$f")" >> "$GITHUB_STEP_SUMMARY"
            cat "$f" >> "$GITHUB_STEP_SUMMARY"
          done
